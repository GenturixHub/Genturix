<analysis>**original_problem_statement:**
The user's primary objective is to harden and prepare the Genturix application for a production launch. The most recent and critical initiative is to build a robust, scalable, seat-based SaaS billing model. This started with an architectural analysis, followed by the implementation of an internal billing engine, a control system for manual SINPE payments, and revenue protection middleware.

The current critical task is to audit and correct the main user onboarding wizard, which was discovered to be completely disconnected from the new billing engine, creating condominiums without any billable seats () and bypassing all financial logic.

PRODUCT REQUIREMENTS:
1.  **SaaS Billing Engine:** Implement a full-featured, seat-based billing system, starting with an internal engine and then adding payment provider integrations.
2.  **Onboarding Integration:** Ensure the primary new condominium onboarding wizard is fully integrated with the billing engine, making  a mandatory and central part of the setup.
3.  **Revenue Protection:** Implement strict backend controls to prevent users from exceeding their allocated  and block module access for delinquent accounts.
4.  **Production Hardening & Security:** Fix all critical security vulnerabilities, including moving JWT refresh tokens from localStorage to secure httpOnly cookies.
5.  **Performance Optimization:** Continue diagnosing and resolving all frontend and backend performance bottlenecks.
6.  **Mobile-First Refactor & UI/UX Polish:** Transform the frontend to a modern, responsive, mobile-first layout.
7.  **Internationalization (i18n):** Fully migrate all critical user flows to be multi-language capable.
8.  **Code Quality & Architecture:** Refactor monolithic components and the main  file.

**User's preferred language**: Español

**what currently exists?**
The application features a comprehensive internal SaaS billing engine, independent of any payment provider. This engine correctly handles , calculates  based on a dynamic pricing system, and manages billing cycles and statuses. A full control system for manual SINPE payments is also implemented, including endpoints for payment confirmation, viewing payment history, and handling seat upgrade requests. Crucially, a seat protection middleware is active, preventing resident creation beyond the  limit.

However, a critical flaw was identified: the main multi-step onboarding wizard for creating new condominiums is completely disconnected from this new billing engine.

**Last working item**:
-   Last item agent was working: Auditing and correcting the multi-step onboarding wizard () which was creating condominiums without any billing information. The agent confirmed the issue by inspecting the database (new condos had ) and the code, then began the correction.
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   Which testing method agent to use? Frontend testing agent. The test must cover the entire onboarding wizard flow. It should verify that the new Plan y Facturación step appears, the dynamic price preview works correctly, and the final created condominium in the database has the correct values for , , , and .
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   **Issue 1: Onboarding wizard is disconnected from the billing engine (P0)**
    -   **Description:** The multi-step onboarding wizard () doesn't have fields for setting , billing cycle, or provider. Consequently, new condominiums created via the wizard have , bypassing the entire SaaS billing logic and revenue protection system.
    -   **Attempted fixes:** The agent has already updated the backend model () and the corresponding endpoint () to accept and process billing data using the billing engine. The agent then started modifying the frontend wizard component to add a new Plan y Facturación step.
    -   **Next debug checklist:**
        1.  Resume and complete the modification of .
        2.  Correctly add the new Plan y Facturación step to the wizard's step logic (the  array and the  function).
        3.  Integrate the new billing state (, , , ) into the main  state object.
        4.  Update the  function to pass the new billing data to the  endpoint.
        5.  Run yarn run v1.22.22
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command. and yarn run v1.22.22
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command. to check for frontend errors.
        6.  Once built, use the testing agent to perform a full end-to-end test of the wizard.
    -   **Why fix this issue and what will be achieved with the fix?** This is a critical business logic flaw. Fixing it ensures that every new condominium is correctly set up for billing from the moment of creation, preventing revenue loss and aligning the onboarding flow with the SaaS model.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Both
    -   **Blocked on other issue:** None.

**In progress Task List**:
-   **Task 1: Integrate Billing Engine into the Onboarding Wizard (P0)**
    -   **Where to resume:** Continue editing . The agent had just defined the new  component and updated the backend. The next action is to fully integrate this step into the wizard's state management, step rendering logic, and final submission handler.
    -   **What will be achieved with this?** The primary onboarding flow for new users will be correctly connected to the SaaS billing engine, making  a mandatory and central part of creating a new condominium.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** Both
    -   **Blocked on something:** None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P1) Implement Full Stripe Integration (Phase 2):** Connect the internal billing engine to Stripe's Subscriptions API for automated recurring payments.
    -   **(P1) Implement Full Stripe Webhook Handling:** Expand the webhook handler to manage subscription lifecycle events (, , ).
    -   **(P1) Implement UI for Deleting 'Used' Pre-registrations.**
    -   **(P1) Complete i18n Migration for Guard Flow:** (, ).
-   **Future Tasks:**
    -   **(P1) Modularize Monolithic Frontend Components:** (, , ).
    -   **(P2) Implement Production Hardening from Audits:** Configure Resend domain and Stripe webhook secrets.
    -   **(P2) CCTV Module Implementation.**
    -   **(P2) Implement HR performance reports for guards.**
    -   **(P3) Refactor the monolithic  file.**

**Completed work in this session**
-   **AUDIT & FIX: Seat-Based Billing Core Logic:** Audited the entire application to confirm that  is the central pillar of the billing system. Corrected frontend dashboard components to display accurate billing data from the engine (, ) instead of legacy values.
-   **FEATURE: SINPE Billing Control & Seat Protection:** Implemented a full financial control system for manual SINPE payments, including endpoints for payment confirmation, viewing payment history, and managing seat upgrade requests. Crucially, implemented a seat protection middleware to block resident creation when .
-   **FEATURE: Internal SaaS Billing Engine:** Architected and built a provider-agnostic internal billing engine from scratch. This included extending data models, creating a central  function, and establishing a  collection for an audit trail.
-   **PERFORMANCE: Cache Persistence & Module Optimization:** Implemented TanStack Query cache persistence to  for instant app-like reloads. Diagnosed and eliminated a ~3-second loading spinner in the Reservations module, achieving a ~96% performance improvement on cached loads.
-   **UI: Framer Motion Transitions:** Added smooth, horizontal slide animations to the main resident modules using Framer Motion.
-   **VERIFICATION: Guard UI TanStack Migration:** Completed and verified the migration of the Guard UI to TanStack Query, confirming all real-time polling and caching functions work correctly.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Resend uses Sandbox Domain:** The  is . Requires user input for a verified custom domain.
-   **Issue 2: Stripe Webhook Lacks Signature Verification:** The endpoint is vulnerable. Requires a secret from the user to be set in the production environment.
-   **Issue 3: No UI to Delete 'Used' Pre-registrations:** The frontend UI is missing a delete button for pre-registrations with .

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **Internal Billing Engine:** A provider-agnostic system for SaaS billing logic built directly into the application, tracking seats, calculating invoices, and managing billing states before involving an external payment provider.
-   **Seat-Based Billing Model:** The core business logic where pricing and access control ( vs ) are the central pillars of the application's monetization strategy.
-   **Revenue Protection Middleware:** Backend logic () that acts as a gatekeeper, preventing resource creation if billing limits are exceeded, thus directly protecting against revenue loss.
-   **TanStack Query Cache Persistence:** Using  and  to persist the query cache across page reloads, providing an instant app feel on subsequent visits.

**key DB schema**
-   **New Collections:**
    -   : { condominium_id, event_type, previous_state, new_state, triggered_by, created_at }
    -   : { condominium_id, amount_paid, seats_at_payment, payment_method, next_billing_date, confirmed_by }
    -   : { condominium_id, current_seats, requested_seats, status }
-   **Modified  collection:** Added several new fields to support the SaaS model, including , , , , , , .

**All files of reference**
-   : Contains all new backend billing logic.
-   : The main dashboard displaying billing information.
-   : The file currently being worked on to fix the critical disconnection.

**Areas that need refactoring**:
-   **:** Now critically oversized at over 15,000 lines due to the addition of the entire billing engine. Refactoring this into a modular structure (e.g., using FastAPI routers for billing, users, condos) is a high-priority future task.
-   **:** The component is a large, monolithic wizard. The current modification to add a billing step is a good opportunity to refactor its state management for better clarity and maintainability.

**key api endpoints**
-   **New Billing Endpoints:**
    -   
    -   
    -   
    -   
    -   
-   **Modified Endpoints:**
    -   : The endpoint being modified to integrate the billing engine.
    -   : Now protected by the  seat protection middleware.

**Critical Info for New Agent**
1.  **FINISH THE ONBOARDING WIZARD FIX (P0):** Your absolute first priority is to fix the critical disconnection between the multi-step onboarding wizard and the billing engine. The backend is already updated. You must resume work on  to add the new Plan y Facturación step, connect it to the wizard's state, and ensure the final submission includes , , and .
2.  **BILLING ENGINE IS THE SOURCE OF TRUTH:** The application now has a robust internal billing engine. All logic related to pricing, seats, and billing status MUST use the data from the  collection (e.g., , ) and the functions in the engine. Do not add any manual calculations in the frontend.
3.  **MAINTAIN SPANISH:** All user-facing communication, including plans and summaries, must be in Spanish.

**documents and test reports created in this job**
-    (Updated multiple times)
-   
-   
-   
-   
-   

**Last 10 User Messages and any pending HUMAN messages**
1.  **AUDIT + CORRECTION - ONBOARDING Y ASIENTOS (IN PROGRESS):** The current, active task to fix the onboarding wizard's disconnection from the billing engine.
2.  **AUDITORÍA CRÍTICA - ASIENTOS POR CONDOMINIO (Completed):** User requested a repeat audit, which the agent confirmed was already done.
3.  **AUDITORÍA CRÍTICA - ASIENTOS POR CONDOMINIO (Completed):** An audit to verify  is the core of the billing system.
4.  **IMPLEMENTACIÓN COMPLETA - SINPE BILLING CONTROL + SEAT PROTECTION (Completed):** Build the financial control system for SINPE payments.
5.  **IMPLEMENTACIÓN FASE 1 - BILLING ENGINE INTERNO (Completed):** Build the internal, provider-agnostic billing engine.
6.  **ANÁLISIS ARQUITECTURAL - CREACIÓN DE CONDOMINIO CON MODELO SaaS (Completed):** An architectural analysis to plan the SaaS model implementation.
7.  **OPTIMIZACIÓN ESPECÍFICA - DELAY EN MÓDULO RESERVACIONES (Completed):** Fix the ~3-second loading spinner in the Reservations module.
8.  **PERSIST TanStack Query CACHE (Completed):** Implement cache persistence across page reloads.
9.  **INTRODUCE SMOOTH TRANSITIONS (Completed):** Add Framer Motion animations to module switching.
10. **DIAGNOSE AND ELIMINATE DELAY (Profile/Reservations) (Completed):** Fix performance delays in the Profile and Reservations modules.

**Project Health Check:**
-   **Broken:** The primary onboarding flow for new condominiums is critically broken. It does not connect to the billing engine, causing new condominiums to be created without any  or billing information, leading to potential revenue loss.

**3rd Party Integrations**
-    (v5)
-   
-    (v5)
-   Resend (Email)
-   Stripe (Payments - partially integrated for one-time checkout, not subscriptions)
-   Web Push ()
-   Firebase Cloud Messaging
-    / 

**Testing status**
-   Testing agent used after significant changes: YES
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created: []
-   Known regressions: None.

**Credentials to test flow:**
-   **Super Admin:**  / 
-   **Resident:**  / 
-   **Guard:**  / 

**What agent forgot to execute**
While implementing the comprehensive billing engine, the agent correctly updated the  used within the SuperAdmin dashboard. However, it overlooked the separate, multi-step  component, which serves as the primary flow for creating new condominiums. This oversight led to the current critical disconnection where the main onboarding path does not use the new billing system. The current task is to rectify this omission.</analysis>
